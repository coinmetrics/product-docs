# Shanghai Primer

**Date:** 23-04-11

In this issue of the State of The Network, we will be covering the Ethereum “Shapella” upgrade, the latest milestone in the ongoing evolution of the Ethereum blockchain. This upgrade, scheduled to take place tomorrow, April 12 at 22:27 UTC, is expected to bring a single important change to the Ethereum ecosystem: introducing the ability of validators to withdraw their stake, which was heretofore locked in the Beacon Chain. The Shapella upgrade includes both the Shanghai upgrade on the Ethereum execution layer (EL) and the simultaneous Capella upgrade on the consensus layer (CL), or Beacon Chain. The Shapella upgrade is an important step forward for Ethereum, and it has been eagerly anticipated by Ethereum developers, institutional investors, and commentators alike. In this issue, we'll take a closer look at the key features and expected outcomes of the upgrade.

Before we dive into the mechanics, it’s important to understand the broader context of this upgrade in order to appreciate its significance. It’s now been over six months since Ethereum completed its historic transition away from Proof-of-Work (PoW) mining to a Proof-of-Stake (PoS) network via The Merge, which we covered in great detail last September. In this extraordinary event in the industry’s nascent history, Ethereum switched out arguably the most important part of the protocol—its consensus mechanism—in realtime, without downtime, or disruption to its millions of users and billions of dollars in value secured on-chain.

The Merge linked up the existing Ethereum mainnet blockchain with another blockchain, called the Beacon Chain, which was purpose-built to carry out PoS activities. In Ethereum’s PoS system, users wishing to participate in consensus commit resources in the form of 32 ETH which are locked-up or “staked” while providing services to validate the network and agree upon the state of the chain as new transactions are submitted. For their services, these users (known as validators, or stakers) are rewarded by the protocol with new ETH and fees paid by Ethereum transactors. Validators are incentivized to perform these services well to maximize their reward potential and additionally held accountable by the risk of more severe “slashing” penalties which cut a validator’s stake when they are provably caught disobeying protocol rules. To-date, just over 18M ETH (~$35B) has been staked representing 15% of all ETH.

It’s important to emphasize that the Beacon Chain was running in parallel to the legacy PoW Ethereum chain before The Merge for almost 2 years. During this time, users joined the active validator set by sending ETH to the Beacon Chain in what was effectively a one-way flow of funds. These early validators have been accruing staking rewards, some all the way back to when the Beacon Chain launched in December 2020. While The Merge was a big success in phasing out mining for staking, it crucially left the implementation of withdrawals—both stake and rewards—to the forthcoming Shapella upgrade.

Consequently, after more than two years this upgrade finally brings an important property of liquidity to validators, opening up a new return route of funds off of the Beacon Chain and back to the Ethereum mainnet execution layer. Aside from the natural benefits offered by better accessibility to funds, validators can now vastly improve their capital efficiency. Due to the specifications of the Beacon Chain, Ethereum validators have no economic incentive to maintain a balance above 32 ETH, as rewards do not compound above the maximum effective balance at 32 ETH. As shown below—due to the accumulation of rewards—the average validator now holds a balance of 34 ETH, which the rational validator will skim back down to 32 ETH so that those rewards can be reallocated, or sold.

Naturally, the potential selling pressure has sparked questions surrounding the ramifications of the unlock both on the impact to the multibillion-dollar staking ecosystem and the market dynamics of ETH. But to understand the possible outcomes, one needs to be well acquainted with the mechanics of withdrawals.

Withdrawals are a critical aspect of the Ethereum staking process, and they allow validators to reclaim their staked funds when they are ready to stop participating in the network. There are two types of withdrawals available to stakers: partial and full. Partial withdrawals allow validators to withdraw any earned staking rewards that are in excess of the initial 32 ETH stake, while still allowing them to remain a validator on the Beacon Chain. Full withdrawals, on the other hand, refer to the withdrawal of the entire balance, including the initial 32 ETH stake and any rewards earned.

Withdrawals are subject to rate-limiting and utilize a queue to limit the amount of withdrawals, similarly to the queue used to limit the entry of new validators to the network. The queue accommodates a fixed rate of partial withdrawals, 512 per epoch, out of which a smaller subset of full withdrawals is allowed based on the number of active validators. Full withdrawals per epoch are determined by a parameter known as the “churn limit,” which also governs the amount of new validators that can join the validator set each epoch. At the present level of active validators (~563K), eight validators can exit every epoch, which has a duration of 6.4 minutes (225 epochs per day). As a result, and at current levels, a maximum of 1,800 validators can perform a full withdrawal per day. This means that it will take a long time to experience big swings in the total number of active validators. Once a full withdrawal is initiated, the user will no longer be considered a validator on the Beacon Chain.

To initiate a partial withdrawal, the user needs to set up a withdrawal credential, which is a one-time process. Once set up, partial withdrawals will happen automatically in a round-robin fashion, with an average of one weekly sweep across every validator. It is also worth noting that withdrawals will be completed as gas-less state changes, so they will not directly add pressure to transaction fees and clog-up Ethereum blockspace.

The Beacon Chain validators feature a specific field called withdrawal credentials. This attribute includes a withdrawal prefix, which represents the first two bytes of the field. Currently, this value can only be set to 0x00 or 0x01. When a deposit is made through a deposit tool, the withdrawal prefix is also set. Validators with a withdrawal address prefix of 0x00 cannot immediately proceed to withdraw their funds. In order for these validators to enable partial and full withdrawals and unlock their funds, once the Capella upgrade takes place on the Beacon Chain, they must first migrate to a 0x01 withdrawal address. As of the writing of today’s issue, no validators have updated their withdrawal credentials, and we will keep an eye on any developments as the upgrade progresses.

One key factor we take into account when estimating withdrawals is the distinct treatment that various liquid staking pools are likely to apply to their respective staked ETH. The Lido Ethereum staking pool is composed of 177,342 validators, represented by stETH, holding over 31% of the entire supply of staked ETH. Notably, Lido is expected to delay access to the withdrawal function until next May. The purpose of this delay is to ensure that there is enough time to add supplementary features to the protocol, including the withdrawal process of their Ethereum staking pool, as well as time for auditing their smart contracts. These features include special withdrawal functions to accommodate different sizes and increase Lido’s resilience to potential mass slashing events, alongside other protocol improvements part of the Lido V2 protocol upgrade. With this in mind, we should reduce our expectations around partial withdrawals since Lido-affiliated validators will have to wait before realizing their withdrawals.

We can estimate the approximate amount of ETH that will be released from the Beacon Chain following the Shapella upgrade by counting the balance in excess of 32 ETH (to be withdrawn via partial withdrawal) and the total balance of validators that have exited or are scheduled to exit (to be withdrawn via full withdrawal).

The amount of ETH that will be withdrawn partially can be estimated by assuming that active validators with balances in excess of 32 ETH will withdraw those funds. As mentioned above, partial withdrawals can take place at a rate of 16 withdrawals every 12 seconds, which means that if all active validators executed partial withdrawals on their excess balances, the queue would clear after around 5 days. The amount of excess ETH stored by validators with excess balances is around 1,141,800.3 ETH, which we can assume will be eventually withdrawn following Shapella. This ETH may be sold off or re-staked into the Beacon Chain.

On top of this value estimated for partial withdrawals, we can consider the amount of ETH that would be withdrawn by full withdrawals to include all validators that are exiting or have exited. This includes around 128,375.5 ETH. This would be exited validators or validators whose balances are available for withdrawal after exiting. The rate of full validator withdrawals is currently around 1,800 a day, with currently around 3,615 validators labeled under this category. This means that inactive validators could withdraw their balances over the course of a single day, assuming only inactive or currently “exited” validators decide to stop staking.

This analysis only considers partial withdrawals for validators with balances in excess of 32 ETH, and full withdrawals for validators that are not currently participating. With these assumptions in mind, there is a hypothetical maximum upper bound of 1,270,176 ETH withdrawn over 5 days after Shanghai is active. However, in reality, the amount of ETH that is actually withdrawn will be far lower than this due to Lido’s delays and the need for validators to update their withdrawal credentials.

As for the demand for full withdrawals, there are a few factors to keep in mind. First, if a large percentage of stakers are long-term ETH holders we do not expect a high demand for unstaking, as long-term holders have an incentive to put their ETH to work and maintain their share of total supply. On the other hand, it is worth noting that macroeconomic conditions have changed drastically during the last two years with short term nominal interest rates rising significantly across the globe. This might make annual staked ETH yields (currently in the 5-7% range) seem relatively less attractive, though as a variable rate, ETH staking rewards can swing to the upside quickly during periods of high demand for blockspace.

Although seemingly a minor upgrade, the Shapella upgrade on the Ethereum network is expected to greatly enhance the ability of institutions and risk-averse individuals to manage their capital more effectively. Consequently, this could increase accessibility to the yield offered on staked ETH. This development has broader implications on the value proposition of ETH to institutions, including long-only funds or funds with short investment time-horizons. Since validators are now able to withdraw their funds after a period of roughly a week, this opens the door for strategies that hedge away ETH spot price risk and simply collect the staking yield over the hedging period.

Ethereum market participants will be closely watching the outcome of the Shapella upgrade. The successful activation of withdrawals will in some ways mark the “cherry on top” of Ethereum’s move to Proof-of-Stake after The Merge and will also be one more step forward in the ambitious Ethereum roadmap.

Bitcoin daily active addresses fell 4% over the week to 980K per day. Ethereum active addresses also fell 4%, to 512K per day.